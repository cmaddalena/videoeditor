<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reels Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/7.8.7/wavesurfer.min.js"></script>
<style>
:root {
  --bg:#080808;--surface:#111;--surface2:#1a1a1a;--border:#222;
  --accent:#e8ff47;--accent2:#ff4757;--text:#f0f0f0;--muted:#555;
  --success:#47ffb2;--sans:'Syne',sans-serif;--mono:'DM Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;}
header{display:flex;align-items:center;justify-content:space-between;padding:18px 40px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:100;}
.logo{font-size:17px;font-weight:800;letter-spacing:-.5px;}
.logo span{color:var(--accent);}
.steps{display:flex;align-items:center;gap:6px;}
.dot{width:7px;height:7px;border-radius:50%;background:var(--border);transition:all .3s;}
.dot.active{background:var(--accent);transform:scale(1.5);}
.dot.done{background:var(--success);}
.step-label{font-family:var(--mono);font-size:11px;color:var(--muted);}
main{max-width:860px;margin:0 auto;padding:56px 40px;}
.panel{display:none;animation:fadeUp .35s ease;}
.panel.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
h1{font-size:56px;font-weight:800;line-height:1;letter-spacing:-2.5px;margin-bottom:10px;}
h1 em{font-style:normal;color:var(--accent);}
h2{font-size:30px;font-weight:800;letter-spacing:-1px;margin-bottom:8px;}
h2 em{font-style:normal;color:var(--accent);}
.sub{font-family:var(--mono);font-size:13px;color:var(--muted);margin-bottom:40px;}
.drop-zone{border:2px dashed var(--border);border-radius:14px;padding:72px 40px;text-align:center;cursor:pointer;transition:all .25s;background:var(--surface);position:relative;}
.drop-zone:hover,.drop-zone.over{border-color:var(--accent);background:rgba(232,255,71,.03);}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.drop-icon{font-size:44px;margin-bottom:14px;display:block;}
.drop-zone h3{font-size:18px;font-weight:700;margin-bottom:6px;}
.drop-zone p{color:var(--muted);font-size:13px;font-family:var(--mono);}
.file-row{display:flex;align-items:center;gap:14px;padding:14px 18px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-top:14px;}
.file-icon{font-size:26px;} .file-name{font-weight:700;font-size:13px;} .file-size{font-family:var(--mono);font-size:11px;color:var(--muted);}
.prog-wrap{background:var(--surface2);border-radius:100px;height:3px;overflow:hidden;margin:10px 0;}
.prog-bar{height:100%;background:var(--accent);border-radius:100px;transition:width .5s ease;width:0%;}
.prog-label{font-family:var(--mono);font-size:12px;color:var(--muted);}
.btn{display:inline-flex;align-items:center;gap:7px;padding:12px 24px;border-radius:9px;font-family:var(--sans);font-weight:700;font-size:14px;cursor:pointer;border:none;transition:all .2s;text-decoration:none;}
.btn-primary{background:var(--accent);color:#000;}
.btn-primary:hover:not(:disabled){background:#d4eb3a;transform:translateY(-1px);}
.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border);}
.btn-ghost:hover:not(:disabled){border-color:var(--accent);color:var(--accent);}
.btn-sm{padding:7px 14px;font-size:12px;}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important;pointer-events:none;}
.actions{display:flex;justify-content:space-between;align-items:center;margin-top:40px;padding-top:22px;border-top:1px solid var(--border);}
.chips{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:22px;}
.chip{font-family:var(--mono);font-size:11px;padding:4px 10px;background:var(--surface2);border-radius:100px;border:1px solid var(--border);color:var(--muted);}
.chip.y{border-color:var(--accent);color:var(--accent);}
.chip.g{border-color:var(--success);color:var(--success);}
.sec-label{font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;display:flex;align-items:center;gap:10px;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}
.transcript-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;min-height:200px;font-family:var(--mono);font-size:14px;line-height:1.9;color:var(--text);outline:none;resize:vertical;width:100%;cursor:text;}
.transcript-box:focus{border-color:var(--accent);}
.transcript-toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px;}
.badge{font-family:var(--mono);font-size:11px;padding:3px 9px;background:var(--surface2);border-radius:100px;color:var(--muted);border:1px solid var(--border);}
.style-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:24px;}
.style-card{background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;text-align:center;transition:all .2s;}
.style-card:hover{border-color:var(--muted);}
.style-card.sel{border-color:var(--accent);background:rgba(232,255,71,.04);}
.style-preview{font-size:10px;font-weight:700;padding:7px 10px;border-radius:5px;margin-bottom:9px;background:#000;display:inline-block;}
.style-name{font-size:13px;font-weight:700;margin-bottom:3px;}
.style-desc{font-size:10px;color:var(--muted);font-family:var(--mono);}
/* wave */
.wave-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:24px;}
.wave-topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.wave-hint{font-family:var(--mono);font-size:11px;color:var(--muted);}
.wave-controls{display:flex;align-items:center;gap:10px;}
.wave-time{font-family:var(--mono);font-size:11px;color:var(--muted);}
.wave-play-btn{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#000;border:none;cursor:pointer;font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.wave-play-btn:hover{background:#d4eb3a;}
.wave-inner{position:relative;}
.broll-markers{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
.broll-marker{position:absolute;top:0;height:100%;border-radius:2px;}
.broll-marker-lbl{position:absolute;bottom:3px;left:4px;font-family:var(--mono);font-size:9px;white-space:nowrap;text-shadow:0 1px 3px rgba(0,0,0,.9);}
.wave-timestamps{display:flex;justify-content:space-between;margin-top:5px;}
.wave-ts{font-family:var(--mono);font-size:10px;color:var(--muted);}
/* brolls */
.broll-list{display:flex;flex-direction:column;gap:12px;margin-bottom:14px;}
.broll-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;display:grid;grid-template-columns:120px 1fr;gap:16px;align-items:start;}
.broll-thumb{width:120px;height:70px;background:var(--surface2);border-radius:8px;overflow:hidden;position:relative;cursor:pointer;}
.broll-thumb video{width:100%;height:100%;object-fit:cover;}
.play-ov{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);font-size:18px;transition:opacity .2s;}
.broll-kw{font-weight:700;font-size:13px;margin-bottom:7px;display:flex;align-items:center;gap:7px;flex-wrap:wrap;}
.tag{font-family:var(--mono);font-size:10px;background:rgba(232,255,71,.12);color:var(--accent);padding:2px 7px;border-radius:100px;}
.broll-timing{display:flex;align-items:center;gap:8px;margin-bottom:9px;}
.time-in{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 9px;color:var(--text);font-family:var(--mono);font-size:12px;width:65px;text-align:center;}
.time-in:focus{outline:none;border-color:var(--accent);}
.broll-footer{display:flex;gap:6px;}
.regen-in{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 10px;color:var(--text);font-family:var(--mono);font-size:11px;flex:1;}
.regen-in:focus{outline:none;border-color:var(--accent);}
.btn-del{background:transparent;border:1px solid #333;color:#555;border-radius:6px;padding:5px 9px;cursor:pointer;font-size:12px;transition:all .2s;}
.btn-del:hover{border-color:var(--accent2);color:var(--accent2);}
/* music */
.music-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:24px;}
.music-box h4{font-size:14px;font-weight:700;margin-bottom:3px;}
.music-box .mdesc{font-family:var(--mono);font-size:11px;color:var(--muted);margin-bottom:14px;}
.music-grid{display:flex;flex-direction:column;gap:7px;margin-bottom:14px;}
.music-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);cursor:pointer;transition:all .2s;}
.music-item:hover{border-color:var(--muted);}
.music-item.sel{border-color:var(--accent);background:rgba(232,255,71,.05);}
.music-item.sel .mdot{background:var(--accent);}
.mdot{width:8px;height:8px;border-radius:50%;background:var(--border);flex-shrink:0;transition:background .2s;}
.mname{font-size:13px;font-weight:700;flex:1;}
.mtags{font-family:var(--mono);font-size:10px;color:var(--muted);}
.vol-row{display:flex;align-items:center;gap:12px;}
.vol-label{font-family:var(--mono);font-size:11px;color:var(--muted);}
.slider{-webkit-appearance:none;height:3px;border-radius:3px;background:var(--border);outline:none;cursor:pointer;}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;}
.sval{font-family:var(--mono);font-size:11px;color:var(--accent);width:36px;text-align:right;}
/* result */
.video-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:22px;}
.video-wrap video{width:100%;max-height:480px;display:block;background:#000;}
.video-meta{padding:18px;display:flex;gap:24px;flex-wrap:wrap;}
.meta-item{display:flex;flex-direction:column;gap:3px;}
.meta-lbl{font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.meta-val{font-weight:700;font-size:16px;}
.color-panel{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:22px;}
.color-panel h4{font-size:14px;font-weight:700;margin-bottom:14px;}
.ctrl-row{display:flex;align-items:center;gap:14px;margin-bottom:12px;}
.ctrl-lbl{font-family:var(--mono);font-size:11px;color:var(--muted);width:80px;flex-shrink:0;}
.regen-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;}
.regen-box h3{font-size:15px;font-weight:700;margin-bottom:10px;}
.regen-box textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:11px;color:var(--text);font-family:var(--mono);font-size:12px;resize:vertical;min-height:72px;margin-bottom:10px;}
.regen-box textarea:focus{outline:none;border-color:var(--accent);}
.locked{opacity:.3;pointer-events:none;}
.toast{position:fixed;bottom:28px;right:28px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:12px 18px;font-family:var(--mono);font-size:12px;z-index:999;transform:translateY(80px);opacity:0;transition:all .3s;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:var(--success);color:var(--success);}
.toast.error{border-color:var(--accent2);color:var(--accent2);}
.spin{width:16px;height:16px;border:2px solid rgba(255,255,255,.15);border-top-color:currentColor;border-radius:50%;animation:rot .7s linear infinite;display:inline-block;}
@keyframes rot{to{transform:rotate(360deg)}}
.field-in{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:var(--mono);font-size:13px;}
.field-in:focus{outline:none;border-color:var(--accent);}
</style>
</head>
<body>

<header>
  <div class="logo">Reels<span>Engine</span></div>
  <div class="steps">
    <div class="dot active" id="d0"></div>
    <div class="dot" id="d1"></div>
    <div class="dot" id="d2"></div>
    <div class="dot" id="d3"></div>
  </div>
  <div class="step-label" id="stepLbl">Paso 1 / 4</div>
</header>
<main>

<!-- PASO 1 -->
<div class="panel active" id="p0">
  <h1>Cre√° tu<br><em>Reel.</em></h1>
  <p class="sub">// Sub√≠ tu video ‚Äî la IA hace el resto</p>
  <div class="drop-zone" id="dropZone">
    <input type="file" id="fileIn" accept="video/*">
    <span class="drop-icon">üé¨</span>
    <h3>Arrastr√° tu video ac√°</h3>
    <p>MP4 ¬∑ MOV ¬∑ HEVC ¬∑ iPhone o webcam ¬∑ m√°x 500MB</p>
  </div>
  <div style="display:flex;align-items:center;gap:12px;margin-top:16px">
    <div style="flex:1;height:1px;background:var(--border)"></div>
    <span style="font-family:var(--mono);font-size:11px;color:var(--muted)">o peg√° un link de Drive</span>
    <div style="flex:1;height:1px;background:var(--border)"></div>
  </div>
  <div style="display:flex;gap:10px;margin-top:16px">
    <input type="text" id="driveUrl" class="field-in" placeholder="https://drive.google.com/file/d/..." style="flex:1">
    <button class="btn btn-ghost" onclick="useDriveUrl()">Usar link ‚Üí</button>
  </div>
  <div class="file-row" id="fileRow" style="display:none">
    <span class="file-icon">üìπ</span>
    <div style="flex:1"><div class="file-name" id="fileName">‚Äî</div><div class="file-size" id="fileSize">‚Äî</div></div>
    <button class="btn btn-ghost btn-sm" onclick="resetFile()">Cambiar</button>
  </div>
  <div id="uploadProg" style="display:none;margin-top:20px">
    <div class="prog-label" id="uploadLbl">Subiendo...</div>
    <div class="prog-wrap"><div class="prog-bar" id="uploadBar"></div></div>
  </div>
  <div class="actions"><div></div><button class="btn btn-primary" id="btnUp" onclick="startUpload()" disabled>Continuar ‚Üí</button></div>
</div>

<!-- PASO 2 -->
<div class="panel" id="p1">
  <h2>Revis√° la <em>transcripci√≥n</em></h2>
  <p class="sub">// Edit√° si hace falta ‚Äî el subrayado es el corrector del browser</p>
  <div class="chips" id="trChips"></div>
  <div class="transcript-toolbar">
    <span class="badge">üá¶üá∑ Espa√±ol</span>
    <span class="badge" id="wCount">‚Äî palabras</span>
    <span class="badge" id="durBadge">‚Äî seg</span>
  </div>
  <div class="sec-label">Clip seleccionado por IA</div>
  <div class="transcript-box" id="trEditor" contenteditable="true" spellcheck="true" lang="es"></div>
  <div class="sec-label" style="margin-top:28px">Estilo de subt√≠tulos</div>
  <div class="style-grid">
    <div class="style-card sel" onclick="selStyle('word_highlight',this)">
      <div class="style-preview" style="color:#00ffff">palabra <span style="color:#fff">por</span> palabra</div>
      <div class="style-name">Word Highlight</div><div class="style-desc">Resalta la palabra activa</div>
    </div>
    <div class="style-card" onclick="selStyle('line',this)">
      <div class="style-preview" style="color:#fff">l√≠nea completa</div>
      <div class="style-name">Line by Line</div><div class="style-desc">Grupos de palabras juntas</div>
    </div>
    <div class="style-card" onclick="selStyle('karaoke',this)">
      <div class="style-preview" style="color:#ff4757">efecto karaoke</div>
      <div class="style-name">Karaoke</div><div class="style-desc">Progresivo al ritmo del habla</div>
    </div>
  </div>
  <div class="actions">
    <button class="btn btn-ghost" onclick="go(0)">‚Üê Volver</button>
    <button class="btn btn-primary" onclick="go(2)">Ver B-Rolls ‚Üí</button>
  </div>
</div>

<!-- PASO 3 -->
<div class="panel" id="p2">
  <h2>Edit√° los <em>B-Rolls</em></h2>
  <p class="sub">// Escuch√° el audio y posicion√° los b-rolls donde m√°s impactan</p>

  <div class="sec-label">Seleccion√° d√≥nde aparecer√°n tus b-rolls</div>
  <div class="wave-box">
    <div class="wave-topbar">
      <span class="wave-hint">Cada bloque de color = un b-roll ¬∑ arrastr√° el timing abajo</span>
      <div class="wave-controls">
        <span class="wave-time" id="waveTime">0:00 / 0:00</span>
        <button class="wave-play-btn" id="btnWavePlay" onclick="toggleWave()">‚ñ∂</button>
      </div>
    </div>
    <div class="wave-inner">
      <div id="waveformEl"></div>
      <div id="brollMarkers" class="broll-markers"></div>
    </div>
    <div class="wave-timestamps">
      <span class="wave-ts" id="waveStart">0s</span>
      <span class="wave-ts" id="waveEnd">‚Äî</span>
    </div>
  </div>

  <div class="broll-list" id="brollList"></div>
  <div style="margin-bottom:20px">
    <button class="btn btn-ghost btn-sm" onclick="addBroll()">+ Agregar b-roll</button>
  </div>

  <div class="sec-label">M√∫sica de fondo</div>
  <div class="music-box">
    <h4>üéµ M√∫sica de fondo</h4>
    <p class="mdesc">// Libre de derechos ¬∑ mezclada suave debajo de tu voz ¬∑ o sub√≠ tu propio MP3</p>
    <div class="music-grid" id="musicGrid"></div>
    <div style="margin-bottom:14px">
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:7px;text-transform:uppercase;letter-spacing:1px">O sub√≠ tu propio MP3</div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="cursor:pointer;display:inline-flex;align-items:center;gap:7px;padding:7px 14px;border-radius:8px;border:1px solid var(--border);font-family:var(--mono);font-size:12px;color:var(--text);background:var(--surface2);transition:all .2s" 
               onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
          üìÅ Elegir archivo
          <input type="file" id="musicUpload" accept="audio/*" style="display:none" onchange="handleMusicUpload(this)">
        </label>
        <span id="musicUploadName" style="font-family:var(--mono);font-size:11px;color:var(--muted)">‚Äî</span>
        <button class="btn btn-ghost btn-sm" onclick="clearMusicUpload()" id="btnClearUpload" style="display:none">‚úï</button>
      </div>
    </div>
    <div class="vol-row">
      <span class="vol-label">Volumen:</span>
      <input type="range" class="slider" id="slMusicVol" min="0" max="0.5" step="0.05" value="0.15"
        oninput="updMusicVol(this)" style="flex:1;max-width:180px">
      <span class="sval" id="vMusicVol">15%</span>
      <button class="btn btn-ghost btn-sm" onclick="clearMusic()" style="margin-left:8px">Sin m√∫sica</button>
    </div>
  </div>

  <div class="actions">
    <button class="btn btn-ghost" onclick="go(1)">‚Üê Volver</button>
    <button class="btn btn-primary" id="btnRender" onclick="startRender()">Generar Reel ‚Üí</button>
  </div>
</div>

<!-- PASO 4 -->
<div class="panel" id="p3">
  <h2>Tu <em>Reel</em> est√° listo</h2>
  <p class="sub" id="p3Sub">// Procesando tu video...</p>

  <div id="renderProg" style="margin-bottom:28px">
    <div class="prog-label" id="renderLbl">Enviando...</div>
    <div class="prog-wrap"><div class="prog-bar" id="renderBar" style="width:5%"></div></div>
  </div>

  <div class="video-wrap" id="videoWrap" style="display:none">
    <video id="resultVid" controls playsinline></video>
    <div class="video-meta" id="videoMeta"></div>
  </div>

  <!-- Color ajustes ‚Äî locked hasta que haya video -->
  <div class="color-panel locked" id="colorPanel">
    <h4>üé® Ajustes de imagen ‚Äî toque final</h4>
    <div class="ctrl-row">
      <span class="ctrl-lbl">Brillo</span>
      <input type="range" class="slider" style="flex:1" id="slBrightness" min="-0.15" max="0.15" step="0.01" value="0.02" oninput="updCtrl('brightness',this)">
      <span class="sval" id="vBrightness">+0.02</span>
    </div>
    <div class="ctrl-row">
      <span class="ctrl-lbl">Contraste</span>
      <input type="range" class="slider" style="flex:1" id="slContrast" min="0.8" max="1.5" step="0.05" value="1.15" oninput="updCtrl('contrast',this)">
      <span class="sval" id="vContrast">1.15</span>
    </div>
    <div class="ctrl-row" style="margin-bottom:14px">
      <span class="ctrl-lbl">Saturaci√≥n</span>
      <input type="range" class="slider" style="flex:1" id="slSaturation" min="0.5" max="2.0" step="0.05" value="1.3" oninput="updCtrl('saturation',this)">
      <span class="sval" id="vSaturation">1.30</span>
    </div>
    <div style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-bottom:10px">‚ö†Ô∏è Aplicar ajustes regenera el video (~3-5 min)</div>
    <button class="btn btn-ghost btn-sm" id="btnApplyColor" onclick="applyColorAdjustments()" disabled>Aplicar ajustes ‚Üí</button>
  </div>

  <!-- Regen box ‚Äî locked -->
  <div class="regen-box locked" id="regenBox" style="margin-bottom:22px">
    <h3>¬øQuer√©s ajustar algo?</h3>
    <textarea id="regenTxt" placeholder="Ej: agrand√° las letras, cambi√° el clip del segundo 10, menos zoom..." disabled></textarea>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn btn-ghost" id="btnRegen" onclick="regenerate()" disabled>üîÑ Regenerar con cambios</button>
      <a class="btn btn-primary locked" id="btnDl" href="#" download="reel.mp4">‚¨á Descargar</a>
    </div>
  </div>

  <div class="actions">
    <button class="btn btn-ghost" onclick="go(2)">‚Üê Editar B-Rolls</button>
    <button class="btn btn-ghost" onclick="startOver()">+ Nuevo video</button>
  </div>
</div>

</main>
<div class="toast" id="toast"></div>
<script>
const API = window.location.origin.includes('localhost') || window.location.origin.includes('127.0.0')
  ? 'http://localhost:8080'
  : 'https://videoeditor-production-0e32.up.railway.app';
const API_SECRET = 'reels2024secretkey';
const PIXABAY_KEY = '54811250-d4f02130e9d8b68bf186049a3'; // still used for fallback
const PEXELS_KEY  = 'zF6CUzMbFFlB9QUSzcprk9Eqf4QSAreqBLxcHdrSSI2MKRb016BBjTkT';

let state = {
  step:0, file:null, driveUrl:null, uploadId:null,
  transcript:null, analysis:null, subtitleStyle:'word_highlight',
  colorGrade:{brightness:0.02, contrast:1.15, saturation:1.3},
  brolls:[], renderJobId:null, outputUrl:null,
  music:null, musicVol:0.15, musicOptions:[],
  audioDuration:0, audioUrl:null, renderPayload:null,
  musicUploadFile:null  // user-uploaded MP3
};
let wavesurfer = null;
let previewAudio = null;

// ‚îÄ‚îÄ Nav ‚îÄ‚îÄ
function go(step) {
  document.getElementById(`p${state.step}`).classList.remove('active');
  document.getElementById(`p${step}`).classList.add('active');
  state.step = step;
  updateDots();
  if (step === 2 && state.audioUrl && !wavesurfer) initWaveform();
  if (step === 2 && !state.musicOptions.length) fetchMusicOptions();
}
function updateDots() {
  [0,1,2,3].forEach(i => {
    const d = document.getElementById(`d${i}`);
    d.className = 'dot' + (i < state.step ? ' done' : i === state.step ? ' active' : '');
  });
  document.getElementById('stepLbl').textContent = `Paso ${state.step+1} / 4`;
}

// ‚îÄ‚îÄ Upload ‚îÄ‚îÄ
const dz = document.getElementById('dropZone');
const fi = document.getElementById('fileIn');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('over'); if (e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]); });
fi.addEventListener('change', e => { if (e.target.files[0]) setFile(e.target.files[0]); });
function setFile(f) {
  state.file = f; state.driveUrl = null;
  document.getElementById('fileName').textContent = f.name;
  document.getElementById('fileSize').textContent = (f.size/1024/1024).toFixed(1)+' MB';
  document.getElementById('fileRow').style.display = 'flex';
  document.getElementById('dropZone').style.display = 'none';
  document.getElementById('btnUp').disabled = false;
}
function resetFile() {
  state.file = null; state.driveUrl = null;
  document.getElementById('fileRow').style.display = 'none';
  document.getElementById('dropZone').style.display = 'block';
  document.getElementById('btnUp').disabled = true;
  fi.value = '';
}
function useDriveUrl() {
  const url = document.getElementById('driveUrl').value.trim();
  if (!url) { toast('Peg√° un link de Drive','error'); return; }
  const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  state.driveUrl = match ? `https://drive.google.com/uc?export=download&id=${match[1]}` : url;
  state.file = null;
  document.getElementById('fileName').textContent = 'Video desde Drive';
  document.getElementById('fileSize').textContent = url.substring(0,50)+'...';
  document.getElementById('fileRow').style.display = 'flex';
  document.getElementById('dropZone').style.display = 'none';
  document.getElementById('driveUrl').value = '';
  document.getElementById('btnUp').disabled = false;
}

async function startUpload() {
  const btn = document.getElementById('btnUp');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span> Procesando...';
  document.getElementById('uploadProg').style.display = 'block';

  try {
    setLbl('uploadLbl', 'üì§ Subiendo video...'); bar('uploadBar', 15, 20000);
    let up;
    if (state.driveUrl) {
      up = await apiFetch('/upload-from-url', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url: state.driveUrl }) });
    } else {
      const fd = new FormData(); fd.append('file', state.file);
      up = await apiFetch('/upload-video', { method:'POST', body: fd });
    }
    state.uploadId = up.job_id;

    setLbl('uploadLbl', 'üéôÔ∏è Extrayendo audio...'); bar('uploadBar', 35, 8000);
    const audio = await apiFetch('/compress-audio', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ video_url: `${API}/serve-video/${state.uploadId}` })
    });
    state.audioUrl = `${API}/download-audio/${audio.job_id}`;

    setLbl('uploadLbl', 'ü§ñ Transcribiendo...'); bar('uploadBar', 60, 30000);
    state.transcript = await apiFetch('/transcribe', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ audio_url: state.audioUrl })
    });

    setLbl('uploadLbl', 'üß† Analizando con GPT...'); bar('uploadBar', 88, 15000);
    const segs = (state.transcript.segments||[]).map(s => ({ id:s.id, start:s.start, end:s.end, text:s.text }));
    state.analysis = await apiFetch('/analyze', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ segments: segs, duration: state.transcript.duration })
    });

    bar('uploadBar', 100, 400);
    setLbl('uploadLbl', '‚úÖ Listo');
    populateTranscript();
    setTimeout(() => go(1), 700);
  } catch(e) {
    toast('Error: ' + e.message, 'error');
    btn.disabled = false; btn.innerHTML = 'Continuar ‚Üí';
  }
}

function populateTranscript() {
  const { transcript: tr, analysis: an } = state;
  const cs = an.clip_start, ce = an.clip_end;
  const words = (tr.words||[]).filter(w => w.start >= cs && w.end <= ce);
  state.audioDuration = ce - cs;

  document.getElementById('wCount').textContent = `${words.length} palabras`;
  document.getElementById('durBadge').textContent = `${Math.round(ce-cs)}s clip`;
  document.getElementById('trChips').innerHTML = `
    <span class="chip y">‚úÇÔ∏è ${cs}s ‚Üí ${ce}s</span>
    <span class="chip g">üéØ ${an.hook_text||'Hook detectado'}</span>
    <span class="chip">‚ö° ${(an.energy_moments||[]).length} energy moments</span>
    <span class="chip">üé¨ ${(an.broll_moments||[]).length} b-rolls</span>
  `;
  const segs = (tr.segments||[]).filter(s => s.start >= cs && s.end <= ce);
  document.getElementById('trEditor').innerHTML = segs.map(s => `<p>${s.text.trim()}</p>`).join('');

  state.brolls = (an.broll_moments||[]).map(m => ({ second: m.second, keyword: m.keyword, url: null, loading: false }));
  renderBrolls();
  state.brolls.forEach((_, i) => fetchPixabay(i));
}


// ‚îÄ‚îÄ Subtitle style ‚îÄ‚îÄ
function selStyle(style, el) {
  state.subtitleStyle = style;
  document.querySelectorAll('.style-card').forEach(c => c.classList.remove('sel'));
  el.classList.add('sel');
}

// ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ
function initWaveform() {
  if (!state.audioUrl) return;
  document.getElementById('waveformEl').innerHTML = '';
  if (wavesurfer) { try { wavesurfer.destroy(); } catch(e){} wavesurfer = null; }
  wavesurfer = WaveSurfer.create({
    container: '#waveformEl',
    waveColor: '#2a2a2a',
    progressColor: 'rgba(232,255,71,0.45)',
    height: 64,
    barWidth: 2, barGap: 1, barRadius: 2,
    cursorColor: 'var(--accent)',
    url: state.audioUrl,
    interact: true
  });
  wavesurfer.on('ready', () => {
    document.getElementById('waveEnd').textContent = Math.round(state.audioDuration)+'s';
    document.getElementById('waveTime').textContent = '0:00 / '+fmtTime(state.audioDuration);
    renderWaveMarkers();
  });
  wavesurfer.on('timeupdate', t => {
    document.getElementById('waveTime').textContent = fmtTime(t)+' / '+fmtTime(state.audioDuration);
  });
  wavesurfer.on('finish', () => {
    document.getElementById('btnWavePlay').textContent = '‚ñ∂';
  });
}
function fmtTime(s) {
  const m = Math.floor(s/60), sec = Math.floor(s%60);
  return m+':'+sec.toString().padStart(2,'0');
}
function toggleWave() {
  if (!wavesurfer) return;
  wavesurfer.playPause();
  document.getElementById('btnWavePlay').textContent = wavesurfer.isPlaying() ? '‚è∏' : '‚ñ∂';
}
function renderWaveMarkers() {
  const dur = state.audioDuration;
  if (!dur) return;
  const colors = [
    {bg:'rgba(232,255,71,.2)',  bdr:'#e8ff47'},
    {bg:'rgba(71,255,178,.2)',  bdr:'#47ffb2'},
    {bg:'rgba(255,71,87,.2)',   bdr:'#ff4757'},
    {bg:'rgba(120,120,255,.2)', bdr:'#7878ff'},
    {bg:'rgba(255,165,0,.2)',   bdr:'#ffa500'},
  ];
  document.getElementById('brollMarkers').innerHTML = state.brolls.map((b,i) => {
    if (!b.url && !b.loading) return '';
    const c = colors[i % colors.length];
    const pct = Math.max(0, Math.min((b.second/dur)*100, 94));
    const wp  = Math.min((5/dur)*100, 100-pct);
    return `<div class="broll-marker" style="left:${pct}%;width:${wp}%;background:${c.bg};border-left:2px solid ${c.bdr};border-right:2px solid ${c.bdr}">
      <span class="broll-marker-lbl" style="color:${c.bdr}">B${i+1} ${b.second}s</span>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ B-Rolls ‚îÄ‚îÄ
const BROLL_COLORS = ['#e8ff47','#47ffb2','#ff4757','#7878ff','#ffa500'];

// Translate Spanish input to Pixabay-friendly English keywords
const ES_EN = {
  'celular':'smartphone','tel√©fono':'phone mobile','sill√≥n':'couch person',
  'cansado':'tired person night','whatsapp':'smartphone chat','mensaje':'phone message',
  'respondiendo':'typing smartphone','ciudad':'city aerial','trabajo':'office work',
  'dinero':'money cash','√©xito':'success business','casa':'house home',
  'reuni√≥n':'business meeting','cliente':'customer handshake','venta':'sales business',
  'automatizaci√≥n':'automation technology','computadora':'laptop computer',
  'persona':'person','gente':'people','noche':'night city','auto':'car road',
  'redes sociales':'social media phone','emprendedor':'entrepreneur laptop',
};
function toEnKeyword(text) {
  if (!text) return 'business';
  const lower = text.toLowerCase();
  for (const [es, en] of Object.entries(ES_EN)) {
    if (lower.includes(es)) return en;
  }
  // Remove accents as fallback
  return text.replace(/[√°√†√§]/g,'a').replace(/[√©√®√´]/g,'e')
             .replace(/[√≠√¨√Ø]/g,'i').replace(/[√≥√≤√∂]/g,'o')
             .replace(/[√∫√π√º]/g,'u').replace(/√±/g,'n');
}

function renderBrolls() {
  document.getElementById('brollList').innerHTML = state.brolls.map((b,i) => `
    <div class="broll-card">
      <div class="broll-thumb" onclick="togglePlay(${i})">
        ${b.url
          ? `<video id="bv${i}" src="${b.url}" muted loop playsinline></video>
             <div class="play-ov" id="po${i}">‚ñ∂</div>`
          : `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)">
               ${b.loading ? '<span class="spin" style="color:var(--accent)"></span>' : 'üîç'}
             </div>`
        }
      </div>
      <div>
        <div class="broll-kw">
          <span style="width:8px;height:8px;border-radius:50%;background:${BROLL_COLORS[i%5]};display:inline-block;flex-shrink:0"></span>
          ${b.keyword||'‚Äî'}
          <span class="tag">Pixabay</span>
        </div>
        <div class="broll-timing">
          <span style="font-family:var(--mono);font-size:11px;color:var(--muted)">Inicio:</span>
          <input type="number" class="time-in" value="${b.second}" min="0"
            onchange="updTime(${i},parseFloat(this.value))">
          <span style="font-family:var(--mono);font-size:11px;color:var(--muted)">seg ¬∑ dura 5s</span>
        </div>
        <div class="broll-footer" style="margin-bottom:6px">
          <input type="text" class="regen-in" placeholder="Describ√≠ qu√© quer√©s ver en espa√±ol..." id="ri${i}">
          <button class="btn btn-ghost btn-sm" onclick="regenBroll(${i})">üîÑ</button>
          <button class="btn-del" onclick="removeBroll(${i})">‚úï</button>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="text" class="regen-in" placeholder="O peg√° URL de video directo..." id="burl${i}" 
            style="font-size:10px;color:var(--muted)" onblur="setBrollUrl(${i}, this.value)">
          <label style="cursor:pointer;font-family:var(--mono);font-size:10px;padding:5px 9px;border:1px solid var(--border);border-radius:6px;color:var(--muted);white-space:nowrap;background:var(--surface2)"
                 title="Subir video propio">
            üìÅ
            <input type="file" accept="video/*" style="display:none" onchange="handleBrollUpload(${i}, this)">
          </label>
        </div>
      </div>
    </div>
  `).join('');
}

function togglePlay(idx) {
  const v = document.getElementById(`bv${idx}`);
  const o = document.getElementById(`po${idx}`);
  if (!v) return;
  if (v.paused) { v.play(); if(o) o.style.opacity='0'; }
  else { v.pause(); v.currentTime=0; if(o) o.style.opacity='1'; }
}
function updTime(idx, val) { state.brolls[idx].second = val; renderWaveMarkers(); }
function addBroll() {
  const last = state.brolls[state.brolls.length-1];
  const s = last ? Math.round(Math.min(last.second+10, state.audioDuration-6)) : 5;
  state.brolls.push({second:s, keyword:'', url:null, loading:false});
  renderBrolls(); renderWaveMarkers();
  setTimeout(() => {
    const cards = document.querySelectorAll('.broll-card');
    if (cards.length) cards[cards.length-1].scrollIntoView({behavior:'smooth',block:'nearest'});
  }, 100);
}
function removeBroll(idx) {
  state.brolls.splice(idx,1); renderBrolls(); renderWaveMarkers();
}
async function fetchPixabay(idx) {
  state.brolls[idx].loading = true; renderBrolls();
  try {
    const raw = state.brolls[idx].keyword || 'business';
    const kw  = toEnKeyword(raw);
    console.log(`broll[${idx}] "${raw}" ‚Üí Pexels: "${kw}"`);

    // Pexels Videos API ‚Äî much better semantic search
    const pr = await fetch(
      `https://api.pexels.com/videos/search?query=${encodeURIComponent(kw)}&per_page=5&orientation=portrait`,
      { headers: { 'Authorization': PEXELS_KEY } }
    );
    const pd = await pr.json();
    const pvid = pd.videos?.[0];
    if (pvid) {
      // Get the best quality <= 1080p vertical file
      const files = pvid.video_files || [];
      const best = files.filter(f => f.height >= 720).sort((a,b) => b.height - a.height)[0]
                || files[0];
      state.brolls[idx].url = best?.link || null;
      state.brolls[idx].pexelsId = pvid.id;
    } else {
      // Fallback to Pixabay
      const kw2 = kw.split(' ')[0];
      const r2 = await fetch(`https://pixabay.com/api/videos/?key=${PIXABAY_KEY}&q=${encodeURIComponent(kw2)}&per_page=3`);
      const d2 = await r2.json();
      state.brolls[idx].url = d2.hits?.[0]?.videos?.medium?.url || null;
    }
  } catch(e) { console.error('broll fetch error', e); }
  state.brolls[idx].loading = false; renderBrolls(); renderWaveMarkers();
}
async function regenBroll(idx) {
  const inp = document.getElementById(`ri${idx}`);
  if (inp.value.trim()) { state.brolls[idx].keyword = inp.value.trim(); inp.value=''; }
  await fetchPixabay(idx);
}

function setBrollUrl(idx, url) {
  if (!url || !url.startsWith('http')) return;
  state.brolls[idx].url = url;
  state.brolls[idx].loading = false;
  renderBrolls(); renderWaveMarkers();
}

function handleBrollUpload(idx, input) {
  const file = input.files?.[0];
  if (!file) return;
  const localUrl = URL.createObjectURL(file);
  state.brolls[idx].url = localUrl;
  state.brolls[idx].uploadFile = file;
  state.brolls[idx].keyword = file.name.replace(/\.[^.]+$/, '');
  renderBrolls(); renderWaveMarkers();
  toast(`Video cargado: ${file.name}`, 'success');
}

// ‚îÄ‚îÄ Music ‚îÄ‚îÄ
// Hardcoded free tracks from ccmixter + freemusicarchive (direct MP3 links, CC licensed)
const MUSIC_TRACKS = [
  {
    label:'Motivacional', tags:'energ√©tico ¬∑ upbeat', emoji:'‚ö°',
    url:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Motivate.mp3'
  },
  {
    label:'Corporativo', tags:'profesional ¬∑ limpio', emoji:'üíº',
    url:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Impact%20Moderato.mp3'
  },
  {
    label:'Cinematogr√°fico', tags:'√©pico ¬∑ dram√°tico', emoji:'üé¨',
    url:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Cylinder%20Five.mp3'
  },
  {
    label:'Lo-Fi / Chill', tags:'relajado ¬∑ suave', emoji:'üåô',
    url:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Comfortable%20Mystery%205.mp3'
  },
  {
    label:'Hip-Hop / Trap', tags:'urbano ¬∑ rythmico', emoji:'üé§',
    url:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Hip%20Hop%20Christmas.mp3'
  },
];

function fetchMusicOptions() {
  // No API call needed ‚Äî tracks are hardcoded
  state.musicOptions = MUSIC_TRACKS.map(t => ({...t}));
  renderMusicGrid();
}

function renderMusicGrid() {
  document.getElementById('musicGrid').innerHTML = state.musicOptions.map((m,i) => `
    <div class="music-item ${state.music?.label===m.label?'sel':''}" id="mi${i}" onclick="selectMusic(${i})">
      <div class="mdot"></div>
      <div style="flex:1">
        <div class="mname">${m.emoji} ${m.label}</div>
        <div class="mtags">${m.tags}</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="prevMusic(event,${i})" id="pbtn${i}">‚ñ∂ Preview</button>
    </div>
  `).join('');
}

function prevMusic(e, idx) {
  e.stopPropagation();
  // Stop any playing preview
  if (previewAudio) {
    previewAudio.pause(); previewAudio = null;
    document.querySelectorAll('[id^=pbtn]').forEach(b => b.textContent = '‚ñ∂ Preview');
  }
  const url = state.musicOptions?.[idx]?.url;
  if (!url) return;
  previewAudio = new Audio(url);
  previewAudio.volume = state.musicVol;
  previewAudio.play().catch(err => {
    console.warn('Preview failed:', err);
    toast('Preview no disponible para este track','error');
  });
  document.getElementById(`pbtn${idx}`).textContent = '‚è∏ Stop';
  previewAudio.onended = () => {
    document.getElementById(`pbtn${idx}`).textContent = '‚ñ∂ Preview';
    previewAudio = null;
  };
}

function selectMusic(idx) {
  state.music = state.musicOptions?.[idx] || null;
  state.musicUploadFile = null; // clear upload if selecting preset
  document.getElementById('musicUploadName').textContent = '‚Äî';
  document.getElementById('btnClearUpload').style.display = 'none';
  document.querySelectorAll('.music-item').forEach((el,i) => el.classList.toggle('sel', i===idx));
}

function clearMusic() {
  state.music = null; state.musicUploadFile = null;
  document.querySelectorAll('.music-item').forEach(el => el.classList.remove('sel'));
  document.getElementById('musicUploadName').textContent = '‚Äî';
  document.getElementById('btnClearUpload').style.display = 'none';
  if (previewAudio) { previewAudio.pause(); previewAudio = null; }
  document.querySelectorAll('[id^=pbtn]').forEach(b => b.textContent = '‚ñ∂ Preview');
}

function updMusicVol(el) {
  state.musicVol = parseFloat(el.value);
  document.getElementById('vMusicVol').textContent = Math.round(state.musicVol*100)+'%';
  if (previewAudio) previewAudio.volume = state.musicVol;
}

// Music file upload
function handleMusicUpload(input) {
  const file = input.files?.[0];
  if (!file) return;
  state.musicUploadFile = file;
  state.music = null; // clear preset selection
  document.querySelectorAll('.music-item').forEach(el => el.classList.remove('sel'));
  document.getElementById('musicUploadName').textContent = file.name;
  document.getElementById('btnClearUpload').style.display = 'inline-flex';
  toast('MP3 listo para usar üéµ', 'success');
}
function clearMusicUpload() {
  state.musicUploadFile = null;
  document.getElementById('musicUploadName').textContent = '‚Äî';
  document.getElementById('btnClearUpload').style.display = 'none';
  document.getElementById('musicUpload').value = '';
}

// ‚îÄ‚îÄ Color controls ‚îÄ‚îÄ
function updCtrl(key, el) {
  state.colorGrade[key] = parseFloat(el.value);
  const v = parseFloat(el.value);
  const fmt = key==='brightness' ? (v>=0?'+':'')+v.toFixed(2) : v.toFixed(2);
  document.getElementById('v'+key.charAt(0).toUpperCase()+key.slice(1)).textContent = fmt;
}
function buildColorFilter() {
  const {brightness:b, contrast:c, saturation:s} = state.colorGrade;
  return `eq=contrast=${c}:saturation=${s}:brightness=${b}:gamma=0.95`;
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function buildPayload(musicUrlOverride) {
  return {
    video_url: `${API}/serve-video/${state.uploadId}`,
    clip_start: state.analysis.clip_start,
    clip_end:   state.analysis.clip_end,
    words:      state.transcript.words || [],
    energy_moments: state.analysis.energy_moments || [],
    broll_urls:    state.brolls.filter(b=>b.url).map(b=>b.url),
    broll_seconds: state.brolls.filter(b=>b.url).map(b=>b.second),
    zoom_enabled: true, zoom_intensity: 0.08, zoom_duration_sec: 1.5,
    color_grade_filter: buildColorFilter(),
    subtitle_style: state.subtitleStyle,
    sub_font:'Arial Black', sub_font_size:74,
    sub_color_primary:'FFFFFF', sub_color_highlight:'00FFFF',
    sub_outline_color:'000000', sub_bold:true,
    sub_outline_size:4, sub_shadow:2, sub_position:2,
    sub_margin_v:180, sub_words_per_line:4,
    music_url: musicUrlOverride !== undefined ? musicUrlOverride : (state.music?.url || ''),
    music_volume: state.musicVol,
    overlay_image_url:'', overlay_text:''
  };
}
async function startRender() {
  const btn = document.getElementById('btnRender');
  btn.disabled = true; btn.innerHTML = '<span class="spin"></span> Enviando...';
  go(3);
  document.getElementById('renderProg').style.display='block';
  document.getElementById('videoWrap').style.display='none';
  bar('renderBar',10,5000);

  // If user uploaded an MP3, upload it first to get a server URL
  let musicUrl = state.music?.url || '';
  if (state.musicUploadFile) {
    try {
      setLbl('renderLbl','üéµ Subiendo m√∫sica...');
      const fd = new FormData(); fd.append('file', state.musicUploadFile);
      const up = await apiFetch('/upload-audio', {method:'POST', body:fd});
      musicUrl = `${API}/download-audio/${up.job_id}`;
    } catch(e) {
      toast('Error subiendo m√∫sica, continuando sin ella','error');
      musicUrl = '';
    }
  }

  state.renderPayload = buildPayload(musicUrl);
  bar('renderBar',20,5000);
  try {
    setLbl('renderLbl','üöÄ Enviando a procesar...');
    const job = await apiFetch('/process-reel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(state.renderPayload)});
    state.renderJobId = job.job_id;
    setLbl('renderLbl','‚öôÔ∏è Procesando (3-5 min)...');
    bar('renderBar',55,180000);
    pollRender(false);
  } catch(e) {
    toast('Error: '+e.message,'error');
    btn.disabled=false; btn.innerHTML='Generar Reel ‚Üí';
  }
}
function pollRender(isColor) {
  const iv = setInterval(async () => {
    try {
      const d = await apiFetch(`/job-status/${state.renderJobId}`);
      if (d.status==='done') {
        clearInterval(iv); bar('renderBar',100,400); setLbl('renderLbl','‚úÖ ¬°Listo!');
        state.outputUrl = `${API}/download/${state.renderJobId}`;
        setTimeout(() => showResult(d, isColor), 700);
      } else if (d.status==='error') {
        clearInterval(iv); setLbl('renderLbl','‚ùå Error');
        toast('Error: '+d.error,'error');
        if (isColor) resetApplyBtn();
      }
    } catch(e){}
  }, 12000);
}
function showResult(d, isColor) {
  document.getElementById('renderProg').style.display='none';
  document.getElementById('videoWrap').style.display='block';
  document.getElementById('resultVid').src = state.outputUrl+'?t='+Date.now();
  document.getElementById('videoMeta').innerHTML = `
    <div class="meta-item"><span class="meta-lbl">Duraci√≥n</span><span class="meta-val">${d.duration}s</span></div>
    <div class="meta-item"><span class="meta-lbl">Tama√±o</span><span class="meta-val">${d.output_size_mb} MB</span></div>
    <div class="meta-item"><span class="meta-lbl">Palabras</span><span class="meta-val">${d.subtitles_words}</span></div>
    <div class="meta-item"><span class="meta-lbl">B-Rolls</span><span class="meta-val">${d.brolls_applied}</span></div>
  `;
  // unlock all
  ['colorPanel','regenBox'].forEach(id => document.getElementById(id).classList.remove('locked'));
  document.getElementById('regenTxt').disabled = false;
  document.getElementById('btnRegen').disabled = false;
  document.getElementById('btnApplyColor').disabled = false;
  resetApplyBtn();
  const dl = document.getElementById('btnDl');
  dl.href = state.outputUrl; dl.classList.remove('locked');
  document.getElementById('p3Sub').textContent = '// Descargalo o ajust√° el color antes';
  toast(isColor ? '¬°Color actualizado! üé®' : '¬°Reel listo! üéâ', 'success');
}
// ‚îÄ‚îÄ Apply color ‚îÄ‚îÄ
function resetApplyBtn() {
  const b = document.getElementById('btnApplyColor');
  b.disabled = false; b.textContent = 'Aplicar ajustes ‚Üí';
}
async function applyColorAdjustments() {
  if (!state.renderPayload) return;
  const payload = {...state.renderPayload, color_grade_filter: buildColorFilter()};
  const btn = document.getElementById('btnApplyColor');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span>';
  document.getElementById('videoWrap').style.display='none';
  document.getElementById('renderProg').style.display='block';
  bar('renderBar',10,5000); setLbl('renderLbl','üé® Aplicando color...');
  try {
    const job = await apiFetch('/process-reel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    state.renderJobId = job.job_id;
    bar('renderBar',55,180000);
    pollRender(true);
  } catch(e) {
    toast('Error: '+e.message,'error');
    resetApplyBtn();
  }
}

function regenerate() { toast('Regenerar con comentarios ‚Äî pr√≥ximamente üöÄ','success'); }
function startOver() {
  if (wavesurfer) { try { wavesurfer.destroy(); } catch(e){} wavesurfer=null; }
  if (previewAudio) { previewAudio.pause(); previewAudio=null; }
  state = {step:0,file:null,driveUrl:null,uploadId:null,transcript:null,analysis:null,
    subtitleStyle:'word_highlight',colorGrade:{brightness:0.02,contrast:1.15,saturation:1.3},
    brolls:[],renderJobId:null,outputUrl:null,music:null,musicVol:0.15,musicOptions:[],musicUploadFile:null,
    audioDuration:0,audioUrl:null,renderPayload:null};
  resetFile(); go(0);
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
async function apiFetch(path, opts={}) {
  const headers = {'Authorization':`Bearer ${API_SECRET}`, ...(opts.headers||{})};
  if (opts.body instanceof FormData) delete headers['Content-Type'];
  const r = await fetch(`${API}${path}`, {...opts, headers});
  if (!r.ok) { const txt = await r.text(); throw new Error(`${path} ‚Üí ${r.status}: ${txt}`); }
  return r.json();
}
let barTimers = {};
function bar(id, target, dur) {
  clearInterval(barTimers[id]);
  const el = document.getElementById(id);
  const from = parseFloat(el.style.width)||0;
  const t0 = Date.now();
  barTimers[id] = setInterval(() => {
    const p = Math.min((Date.now()-t0)/dur,1);
    el.style.width = (from+(target-from)*p)+'%';
    if(p>=1) clearInterval(barTimers[id]);
  },50);
}
function setLbl(id,txt){document.getElementById(id).textContent=txt;}
function toast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast show ${type}`;
  setTimeout(()=>t.classList.remove('show'),3500);
}
</script>
</body>
</html>
